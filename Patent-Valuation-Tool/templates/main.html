<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patent Valuation Tool</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body>

  <header class="main-header">
    <h1>Patent Valuation Tool</h1>
    <div class="user-info">
        <a href="#" id="user-icon" style="color: white; text-decoration: none; font-size: 1.5em;">ðŸ‘¤</a>
        <div id="user-dropdown" class="dropdown-content">
            <p>Welcome, <strong id="profile-username">...</strong></p>
            <p>Email: <span id="profile-email">...</span></p>
            <hr>
            <button id="show-history-btn" class="dropdown-btn">Previous Calculations </button>
            
            <form method="POST" action="{{ url_for('delete_account') }}" onsubmit="return confirm('WARNING: Are you sure you want to delete your account? This is irreversible and all your calculation history will be LOST.')" style="margin-top: 5px;">
                <button type="submit" class="dropdown-btn delete-account-btn">Delete Account</button>
            </form>
            
            <a href="{{ url_for('logout') }}" class="dropdown-btn logout-btn">Logout</a>
            
            {% if current_user.is_admin %}
                <a href="{{ url_for('admin_manage_users') }}" class="dropdown-btn admin-btn">Admin Portal</a>
            {% endif %}
        </div>
    </div>
  </header>

  <div class="main-container">

    <section class="input-section">
      <h2>Inputs</h2>

      <label for="V">Asset Value V (â‚¬1000s):</label>
      <input id="V" type="number" step="any" placeholder="e.g. 650" required>

      <label for="K">Exercise Cost K (â‚¬1000s):</label>
      <input id="K" type="number" step="any" placeholder="e.g. 650" required>

      <label for="T">Time to Maturity T (Years):</label>
      <input id="T" type="number" step="any" placeholder="e.g. 16" required>
      
      <label for="sigma">Volatility :</label>
      <input id="sigma" type="number" step="any" placeholder="e.g. 0.506" required>

      <label for="delta-mode">Cost of Delay  Mode:</label>
      <select id="delta-mode">
          <option value="auto">Automatic Increment Model</option>
          <option value="manual">Manual Per-Period Input</option>
      </select>

      <label for="delta-auto" id="delta-auto-label">Initial Cost of Delay :</label>
      <input id="delta-auto" type="number" step="any" placeholder="e.g. 0.1246" required>
      
      <button type="button" id="manual-delta-btn" class="btn" style="display: none; width: 100%; margin-top: 5px;">Set Manual Costs</button>

      <label for="r">Risk-free Rate r:</label>
      <input id="r" type="number" step="any" placeholder="e.g. 0.02" required>

      
      <button type="button" id="run-btn" class="btn">Run Calculation</button>
    </section>

    <section class="output-section">
     
      
      <div class="dashboard-grid">
          <div class="output-box summary-output" id="option-value">
              Option value will appear here
          </div>
          
          <div class="chart-container chart-1" id="line-chart-v-sigma-container">
              <h3>Option Value Sensitivity: Asset Value (V) vs. Volatility</h3>
              <canvas id="line-chart-v-sigma"></canvas>
          </div>
          
          <div class="chart-container chart-2" id="line-chart-delta-sigma-container">
              <h3>Volatility vs. Cost of Delay Impact on Option Value</h3>
              <canvas id="line-chart-delta-sigma"></canvas>
          </div>
          
          <div class="chart-container chart-3" id="tornado-chart-container">
              <h3>Absolute Sensitivity Ranking (Â±10% Input Change)</h3>
              <canvas id="tornado-chart"></canvas>
          </div>
          
          <div class="chart-container chart-4" id="spider-chart-container">
              <h3>Relative Sensitivity (Â±10% Change) of Core Inputs</h3>
              <canvas id="spider-chart"></canvas>
          </div>
      </div>

    </section>

  </div>

  <footer>
    <button type="button" id="download-btn" class="download-btn">Download Excel</button>
    <p>&copy; 2025 PatentFlex</p>
  </footer>

  <div id="manual-delta-modal" style="display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 10px;">
      <h2>Manual Cost of Delay Inputs</h2>
      <div id="manual-delta-inputs">
      </div>
      <button type="button" id="save-manual-delta" class="btn" style="margin-top: 20px;">Save Costs</button>
      <button type="button" id="cancel-manual-delta" class="btn" style="margin-top: 20px; background-color: #f44336;">Cancel</button>
    </div>
  </div>

  <div id="history-modal" class="modal-overlay">
    <div class="modal-content">
      <h2>Previous Calculations</h2>
      <div id="history-list">
        </div>
      <div id="calculation-details" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; display: none;">
          <h3>Calculation Details</h3>
          <p><strong>Timestamp:</strong> <span id="detail-timestamp"></span></p>
          <hr>
          <h4>Input Parameters:</h4>
          <pre id="detail-inputs"></pre>
          <p><strong>Initial Option Value (Câ‚€):</strong> <strong id="detail-option-value" style="color: #4caf50;"></strong></p>
      </div>
      <button id="close-history-modal" class="btn" style="background-color: #f44336; margin-top: 20px;">Close</button>
    </div>
  </div>


  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const user_data = {
            username: "{{ current_user.username if current_user.is_authenticated else 'Guest' }}",
            email: "{{ current_user.email if current_user.is_authenticated else 'N/A' }}",
            is_admin: "{{ current_user.is_admin if current_user.is_authenticated else 'False' }}" === 'True',
            is_super_admin: "{{ current_user.is_super_admin if current_user.is_authenticated else 'False' }}" === 'True'
        };
        // Initialize profile in JS
        updateUserProfile(user_data);
    });
  </script>
</body>
</html>
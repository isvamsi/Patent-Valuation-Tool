<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Portal - User Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        .admin-container {
            max-width: 950px;
            margin: 50px auto;
            padding: 30px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .admin-container h2 { color: #4caf50; margin-bottom: 25px; }
        .user-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .user-table th, .user-table td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: middle;}
        .user-table th { background-color: #f2f2f2; color: #333; }
        
        .flash-message { padding: 10px; margin-bottom: 15px; border-radius: 6px; font-weight: bold;}
        .flash-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .flash-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }

        .form-group { margin-bottom: 15px; }
        .checkbox-group { 
            display: flex; 
            align-items: center; 
            margin-top: 5px; 
            margin-bottom: 15px;
        }
        .checkbox-group input { width: auto; margin-right: 10px; margin-bottom: 0 !important; }
        .checkbox-group label { margin: 0; font-weight: normal; margin-top: 0 !important; }
        
        .delete-btn { background-color: #f44336; padding: 5px 10px; font-size: 0.9em; margin: 0; }
        .delete-btn:hover { background-color: #da190b; }

        .role-toggle-form { display: inline-block; margin-left: 5px; }
        .role-toggle-btn { background-color: #337ab7; padding: 5px 10px; font-size: 0.9em; margin: 0; }
        .role-toggle-btn.admin-off { background-color: #5cb85c; }
        
        .super-admin-btn { 
            background-color: #f7941d; /* Orange/Gold color */
            padding: 5px 10px; 
            font-size: 0.9em; 
            margin-left: 5px;
        }
        .super-admin-btn:hover {
            background-color: #e08316;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <h1>Admin Portal - User Management</h1>
    </header>
    <div class="admin-container">
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <h2>Add New User</h2>
        <form method="POST" action="{{ url_for('admin_manage_users') }}">
            <input type="hidden" name="action" value="add_user">
            
            <label for="username">Username:</label>
            <input id="username" name="username" type="text" required>

            <label for="email">Email:</label>
            <input id="email" name="email" type="email" required>

            <label for="password">Password:</label>
            <input id="password" name="password" type="password" required>
            
            <div class="checkbox-group">
                <input id="is_admin" name="is_admin" type="checkbox">
                <label for="is_admin">Grant Admin Privileges</label>
            </div>
            
            {% if current_user.is_super_admin %}
            <div class="checkbox-group">
                <input id="is_super_admin" name="is_super_admin" type="checkbox">
                <label for="is_super_admin" style="color: #f44336; font-weight: bold;">Grant Super Admin Privileges</label>
            </div>
            {% endif %}

            <button type="submit" class="btn">Create User</button>
        </form>

        <hr style="margin: 30px 0;">

        <h2>Existing Users</h2>
        <table class="user-table">
            <thead>
                <tr>
                    <th>#</th> <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ loop.index }}</td> <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                        {{ 'Super Admin' if user.is_super_admin else ('Admin' if user.is_admin else 'User') }}
                    </td>
                    <td>
                        <form method="POST" action="{{ url_for('admin_manage_users') }}" style="display: inline-block;">
                            <input type="hidden" name="action" value="delete_user">
                            <input type="hidden" name="user_id" value="{{ user.id }}">
                            <button type="submit" class="btn delete-btn" 
                                onclick="return confirm('Are you sure you want to delete user {{ user.username }}? This action is irreversible and deletes all their calculations.')"
                                {% if user.is_super_admin and current_user.username != 'Grid.Thoma' %}
                                    disabled title="Only the Super Admin can delete other Super Admins."
                                {% endif %}
                                >Delete
                            </button>
                        </form>
                        
                        {% if current_user.is_admin %}
                        <form method="POST" action="{{ url_for('admin_manage_users') }}" class="role-toggle-form">
                            <input type="hidden" name="action" value="toggle_admin">
                            <input type="hidden" name="user_id" value="{{ user.id }}">
                            {% if user.is_admin %}
                                <button type="submit" class="btn role-toggle-btn" 
                                {% if user.username == 'Grid.Thoma' %} 
                                disabled title="Primary Super Admin role cannot be modified." 
                                {% endif %}
                                onclick="return confirm('Revoke Admin role for {{ user.username }}?')">Revoke Admin</button>
                            {% else %}
                                <button type="submit" class="btn role-toggle-btn admin-off" onclick="return confirm('Grant Admin role for {{ user.username }}?')">Grant Admin</button>
                            {% endif %}
                        </form>
                        {% endif %}

                        {% if current_user.is_super_admin and user.id != current_user.id %}
                        <form method="POST" action="{{ url_for('admin_manage_users') }}" class="role-toggle-form">
                            <input type="hidden" name="action" value="set_super_admin">
                            <input type="hidden" name="user_id" value="{{ user.id }}">
                            <button type="submit" class="btn super-admin-btn"
                                onclick="return confirm('WARNING: Are you sure you want to transfer the Super Admin role to {{ user.username }}? This will demote YOU to a regular user/admin and require a fresh login.')"
                                >Transfer Super Admin
                            </button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <p style="text-align: right; margin-top: 20px;">
            <a href="{{ url_for('dashboard') }}" class="btn" style="background-color: #555; text-decoration: none;">Back to Main Tool</a>
        </p>

    </div>
    
    <footer>
        <p>&copy; 2025 PatentFlex</p>
    </footer>
</body>
</html>
